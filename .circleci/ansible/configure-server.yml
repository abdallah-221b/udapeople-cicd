# - name: "configuration play."
#   hosts: web
#   remote_user: ubuntu
#   become: true
#   become_method: sudo
#   become_user: root
#   gather_facts: false
#   vars:
#     ansible_python_interpreter: /usr/bin/python3
#     ansible_host_key_checking: false
#     ansible_stdout_callback: yaml

#   pre_tasks:
#     - name: "wait 600 seconds for target connection to become reachable/usable."
#       wait_for_connection:
#         timeout: 600

#     - name: "install python for Ansible."
#       become: true
#       raw: test -e /usr/bin/python3 || (apt -y update && apt install -y python3)
#       changed_when: false

#     - setup:

#   roles:
#     - configure-server
#     - configure-prometheus-node-exporter
###############  AI code :
- name: "configuration play."
  hosts: web
  remote_user: ubuntu
  become: true
  become_method: sudo
  become_user: root
  gather_facts: false # Setting gather_facts to false initially
  vars:
    ansible_python_interpreter: /usr/bin/python3 
    ansible_host_key_checking: false
    ansible_stdout_callback: yaml

  pre_tasks:
    - name: "Wait 600 seconds for target connection to become reachable/usable."
      wait_for_connection:
        timeout: 600

    # Ensure Python3 exists for Ansible modules BEFORE trying to use apt module
    - name: "Bootstrap: Install python3 if not present (raw)."
      raw: test -e /usr/bin/python3 || (apt -y update && apt install -y python3)
      register: python_install_result
      changed_when: "'install' in python_install_result.stdout" # Becomes true only if install command ran
      become: true

    # Add task to update CA certificates on the target machine
    - name: "Ensure CA certificates are up-to-date on target."
      apt: # Assuming Debian/Ubuntu based targets like the raw command implies
        name: ca-certificates
        state: latest
        update_cache: yes
      become: true # This task needs root privileges

    # Explicitly gather facts *after* python is potentially installed and certs updated
    # This is often needed for roles that rely on facts.
    - name: "Gather facts after bootstrapping."
      setup:

  roles:
    - configure-server
    - configure-prometheus-node-exporter
  